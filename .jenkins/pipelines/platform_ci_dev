pipeline {
    agent any

    environment {
        AZURE_CREDENTIALS = credentials('AZURE_CREDENTIALS')
    }

    parameters {
        string(name: 'flow_type', defaultValue: 'named_entity_recognition', description: 'The flow use-case to execute')
        string(name: 'env_name', defaultValue: 'dev', description: 'Execution Environment')
        string(name: 'deployment_type', defaultValue: 'aml', description: 'Determine type of deployment - aml, aks, docker, webapp')
    }

    stages {
        stage('Checkout Actions') {
            steps {
                cleanWs()
                checkout scm
            }
        }

         stage('Azure Login') {
            steps {
                withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                    sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'
                }
            }
        }

        stage('Configure Azure ML Agent') {
            steps {
                script {
                    build job: 'jobs/configure_azureml_agent', parameters: [
                        string(name: 'flow_type', value: "${params.flow_type}")
                    ]
                }
            }
        }

        stage('Register experiment data asset') {
            steps {
                withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                    withPythonEnv('/usr/bin/python3.11') {
                    sh '''
                    python -m pip install -r .jenkins/requirements/execute_job_requirements.txt
                    python -m llmops.common.register_data_asset \\
                    --subscription_id $AZURE_SUBSCRIPTION_ID \\
                    --data_purpose "training_data" \\
                    --flow_to_execute $flow_type \\
                    --env_name $env_name
                    '''
                }
            }

            }
        }


        stage('Execute prompt flow bulk run') {
            steps {
                withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                    withPythonEnv('/usr/bin/python3.11') {
                    sh '''
                    python -m pip install -r .jenkins/requirements/build_validation_requirements.txt
                    python -m llmops.common.prompt_pipeline \\
                    --subscription_id $AZURE_SUBSCRIPTION_ID \\
                    --data_purpose "training_data" \\
                    --flow_to_execute $flow_type \\
                    --build_id $BUILD_NUMBER \\
                    --env_name $env_name \\
                    --output_file run_id.txt
                    '''
                }
            }
            }
        }


        stage('Register evaluation data asset') {
            steps {
                withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                    withPythonEnv('/usr/bin/python3.11') {
                    sh '''
                    python -m llmops.common.register_data_asset \\
                    --subscription_id $AZURE_SUBSCRIPTION_ID \\
                    --data_purpose ""test_data"" \\
                    --flow_to_execute $flow_type \\
                    --env_name $env_name
                    '''
                }
            }
            }
        }

        stage('Export run_id as environment variable') {
            steps {
                script {
                    def run_id = sh (returnStdout: true, script: 'cat run_id.txt').trim()
                    env.run_id = run_id
                    sh 'echo $run_id'

                }    
            }
        }


        stage('Read prompt flow runs & Execute bulk run evaluations') {
            steps {
                withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                    withPythonEnv('/usr/bin/python3.11') {
                    sh '''
                    run_id=$(cat run_id.txt)
                    echo $run_id
                    python -m llmops.common.prompt_eval \\
                    --subscription_id $AZURE_SUBSCRIPTION_ID \\
                    --build_id $BUILD_NUMBER \\
                    --data_purpose ""test_data"" \\
                    --flow_to_execute $flow_type \\
                    --env_name $env_name \\
                    --run_id $run_id
                    '''
                }
            }
            }
        }

        stage('Archive CSV') {
            steps {
                script {
                    archiveArtifacts artifacts: './reports', allowEmptyArchive: true, onlyIfSuccessful: true
                }
            }
        }

        stage('Execute Platform CD Pipeline to deploy flow') {
            steps {
                script {
                    build job: 'platform_cd_dev', parameters: [
                        string(name: 'flow_type', value: "${params.flow_type}"),
                        string(name: 'env_name', value: "${params.env_name}"),
                        string(name: 'deployment_type', value: "${params.deployment_type}"),
                        string(name: 'run_id', value: "${run_id}")
                    ]
                }
            }
        }
    }
}

